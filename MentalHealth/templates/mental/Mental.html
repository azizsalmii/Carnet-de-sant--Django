{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MindCare - AI Mental Health Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --secondary: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --info: #118ab2;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-hover: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
      --gradient: linear-gradient(135deg, var(--primary), var(--primary-light));
      --gradient-secondary: linear-gradient(135deg, var(--secondary), #07c290);
      --gradient-warning: linear-gradient(135deg, var(--warning), #ffb347);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .main-app {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      margin-bottom: 30px;
    }

    .app-header {
      background: var(--gradient);
      color: white;
      padding: 40px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .app-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.3;
    }

    .app-content {
      padding: 40px;
    }

    h1 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .tagline {
      font-size: 1.3rem;
      opacity: 0.9;
      font-weight: 300;
    }

    .nav-tabs {
      display: flex;
      background: var(--bg);
      border-radius: 16px;
      padding: 8px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }

    .nav-tab {
      flex: 1;
      padding: 15px 20px;
      text-align: center;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      color: var(--text-light);
    }

    .nav-tab.active {
      background: var(--gradient);
      color: white;
      box-shadow: var(--shadow);
    }

    .nav-tab:hover:not(.active) {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .analysis-section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .analysis-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .input-container {
      position: relative;
      margin-bottom: 20px;
    }

    form textarea {
      width: 100%;
      padding: 20px;
      border-radius: 16px;
      border: 2px solid var(--border);
      font-size: 1rem;
      resize: none;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      background: white;
      min-height: 120px;
    }

    form textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .char-count {
      position: absolute;
      bottom: 10px;
      right: 15px;
      font-size: 0.8rem;
      color: var(--text-light);
      background: white;
      padding: 2px 8px;
      border-radius: 10px;
    }

    button {
      background: var(--gradient);
      color: #fff;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: var(--shadow);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .btn-secondary {
      background: var(--gradient-secondary);
    }

    .btn-warning {
      background: var(--gradient-warning);
    }

    .emotion-badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: var(--gradient);
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      font-weight: 600;
      margin: 0 auto 30px;
      box-shadow: var(--shadow);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin: 30px 0;
    }

    .score-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .score-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient);
    }

    .score-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    .score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .score-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
    }

    .score-average {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--secondary);
      line-height: 1;
    }

    .score-label {
      color: var(--text-light);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .score-bar {
      width: 100%;
      background: #e2e8f0;
      border-radius: 10px;
      height: 12px;
      margin-top: 15px;
      overflow: hidden;
    }

    .score-fill {
      height: 100%;
      background: var(--gradient);
      width: 0;
      border-radius: 10px;
      transition: width 1.2s ease-in-out;
    }

    .wellness-score {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      margin: 20px 0;
    }

    .wellness-score .score {
      font-size: 3rem;
      font-weight: 700;
      margin: 10px 0;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .dashboard-card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary);
    }

    .dashboard-card h4 {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .dashboard-card .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .conclusion-section {
      background: linear-gradient(135deg, #f0f4ff, #e6f0ff);
      border-radius: 20px;
      padding: 30px;
      margin: 25px 0;
      border-left: 5px solid var(--primary);
    }

    .conclusion-section h3 {
      margin-bottom: 15px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .conclusion-text {
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--text);
      background: white;
      padding: 25px;
      border-radius: 16px;
      border-left: 4px solid var(--secondary);
      box-shadow: var(--shadow);
    }

    .recommendations {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-radius: 20px;
      padding: 30px;
      margin: 25px 0;
      border-left: 5px solid var(--primary);
    }

    .recommendations h3 {
      margin-bottom: 20px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .recommendations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .recommendation-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.3s ease;
    }

    .recommendation-card:hover {
      transform: translateY(-3px);
    }

    .daily-challenge {
      background: linear-gradient(135deg, #fff9f0, #fff4e6);
      border-radius: 20px;
      padding: 25px;
      margin: 25px 0;
      border-left: 5px solid var(--warning);
    }

    .challenge-content {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .challenge-icon {
      font-size: 2rem;
      color: var(--warning);
    }

    .chatbot-section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin: 25px 0;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .chat-messages {
      height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      background: #fafafa;
    }

    .message {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 0.95rem;
    }

    .message.bot .message-bubble {
      background: white;
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message.user .message-bubble {
      background: var(--gradient);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-input {
      display: flex;
      gap: 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 15px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
    }

    .quiz-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin: 25px 0;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .quiz-section h3 {
      margin-bottom: 15px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quiz-description {
      color: var(--text-light);
      margin-bottom: 25px;
      font-size: 1rem;
      line-height: 1.5;
    }

    .quiz-question {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .quiz-question:last-child {
      border-bottom: none;
    }

    .quiz-question p {
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text);
      font-size: 1.1rem;
    }

    .quiz-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .quiz-options label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      border-radius: 12px;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
    }

    .quiz-options label:hover {
      background: #f8fafc;
      border-color: var(--primary-light);
    }

    .quiz-options input[type="radio"]:checked + span {
      font-weight: 600;
      color: var(--primary);
    }

    .quiz-options label.selected {
      background: var(--primary-light);
      color: white;
      border-color: var(--primary);
    }

    .quiz-submit {
      margin-top: 25px;
      text-align: center;
    }

    .analysis-progress {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
      padding: 20px;
      background: var(--bg);
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      color: var(--text-light);
      padding: 10px 20px;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .progress-step.active {
      background: var(--gradient);
      color: white;
      box-shadow: var(--shadow);
    }

    .progress-step.completed {
      background: var(--gradient-secondary);
      color: white;
    }

    .entries {
      margin-top: 40px;
    }

    .entries-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .entry {
      background: white;
      border-radius: 16px;
      margin-bottom: 20px;
      padding: 25px;
      box-shadow: var(--shadow);
      border-left: 5px solid var(--primary);
      transition: transform 0.2s, box-shadow 0.2s;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
    }

    .entry:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    .entry.negative { border-left-color: var(--danger); }
    .entry.neutral { border-left-color: var(--warning); }
    .entry.positive { border-left-color: var(--secondary); }

    .entry-content {
      flex: 1;
    }

    .entry-meta {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .entry-date {
      font-weight: 600;
      color: var(--text);
    }

    .entry-emotion {
      background: var(--primary-light);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .entry.negative .entry-emotion { background: var(--danger); }
    .entry.neutral .entry-emotion { background: var(--warning); color: #333; }
    .entry.positive .entry-emotion { background: var(--secondary); }

    .entry-text {
      margin: 12px 0;
      color: var(--text);
      line-height: 1.5;
    }

    .entry-stats {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }

    .entry-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .entry-score {
      text-align: right;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-end;
    }

    .score-circle {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.3rem;
      background: var(--gradient);
      color: white;
      box-shadow: var(--shadow);
    }

    .entry.negative .score-circle { background: var(--danger); }
    .entry.neutral .score-circle { background: var(--warning); color: #333; }
    .entry.positive .score-circle { background: var(--secondary); }

    .error {
      background: #fef2f2;
      color: var(--danger);
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      text-align: center;
      font-weight: 500;
      border-left: 4px solid var(--danger);
      box-shadow: var(--shadow);
    }

    .success {
      background: #f0f9ff;
      color: var(--primary);
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      text-align: center;
      font-weight: 500;
      border-left: 4px solid var(--primary);
      box-shadow: var(--shadow);
    }

    .chart-container {
      margin-top: 40px;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    hr {
      border: none;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--border), transparent);
      margin: 40px 0;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      color: var(--border);
      opacity: 0.5;
    }

    .empty-state h3 {
      margin-bottom: 10px;
      color: var(--text-light);
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .app-content {
        padding: 20px;
      }
      
      .results-grid {
        grid-template-columns: 1fr;
      }
      
      .entry {
        grid-template-columns: 1fr;
        text-align: center;
      }
      
      .entry-score {
        align-items: center;
        margin-top: 15px;
      }
      
      .nav-tabs {
        flex-direction: column;
      }
      
      .recommendations-grid {
        grid-template-columns: 1fr;
      }
      
      .quiz-options {
        grid-template-columns: 1fr;
      }
      
      .message-bubble {
        max-width: 85%;
      }
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .fade-in {
      animation: slideIn 0.5s ease;
    }

    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Stylish gray small buttons for entry controls */
    .btn-gray {
      background: linear-gradient(180deg, #f3f4f6 0%, #e9ecef 100%);
      color: #111827;
      border: 1px solid #d1d5db;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      transition: transform 0.14s ease, box-shadow 0.14s ease, background 0.14s ease;
      font-size: 0.9rem;
      line-height: 1;
    }

    .btn-gray:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      background: linear-gradient(180deg, #eceff1 0%, #e2e6ea 100%);
    }

    .btn-gray:active { transform: translateY(0); }

    /* Icon sizing and spacing */
    .btn-gray i {
      font-size: 0.95rem;
      display: inline-block;
      width: 1em;
      text-align: center;
    }

    /* Screen-reader only helper */
    .sr-only {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }

    /* Delete button variant: keep gray but tint icon red for clarity */
    .btn-delete i { color: #dc2626; }

    /* Edit button variant: subtle primary tint on hover */
    .btn-edit:hover { background: linear-gradient(180deg, #eef2ff 0%, #e6eeff 100%); }

    /* Small spacing for the control container */
    .entry-controls { display: inline-flex; gap: 8px; align-items: center; }

  /* Modal styles for edit card */
  .modal-backdrop { display: none; position: fixed; inset: 0; background: rgba(2,6,23,0.55); align-items: center; justify-content: center; z-index: 9998; }
  .modal-backdrop.show { display: flex; }
  .modal { display: none; position: fixed; inset: 0; z-index: 9999; align-items: center; justify-content: center; }
  .modal.show { display: flex; }
  .modal-card { background: #fff; width: min(720px, 96%); border-radius: 14px; padding: 18px; box-shadow: 0 20px 50px rgba(2,6,23,0.2); transform: translateY(0); transition: transform 0.18s ease, opacity 0.18s ease; max-height: 90vh; overflow: auto; }
  .modal-header { display:flex; justify-content:space-between; align-items:center; gap:10px; border-bottom:1px solid #eef2f6; padding-bottom:10px; margin-bottom:12px; }
  .modal-title { font-size: 1.05rem; font-weight: 700; color: var(--text); }
  .modal-body textarea { width:100%; min-height:120px; padding:12px; border-radius: 10px; border: 1px solid #e6edf3; background: #fbfdff; resize: vertical; font-size: 0.98rem; }
  .modal-row { display:flex; gap:12px; align-items:center; margin-top:10px; }
  .modal-label { font-size:0.9rem; color:var(--text-light); min-width:90px; }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:14px; }
  .btn-save { background: var(--gradient); color:white; padding:10px 16px; border-radius:10px; border:none; font-weight:700; }
  .btn-cancel { background: transparent; border: 1px solid #e6edf3; padding:10px 14px; border-radius:10px; }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="main-app">
    <!-- Header -->
    <div class="app-header">
      <h1><i class="fas fa-brain"></i> MindCare</h1>
      <p class="tagline">Your Intelligent AI Mental Health Companion</p>
    </div>

    <!-- Navigation Tabs -->
    <div class="app-content">
      <div class="nav-tabs">
        <div class="nav-tab active" data-tab="analysis">üß† Emotional Analysis</div>
        <div class="nav-tab" data-tab="chatbot">ü§ñ Therapeutic Chat</div>
        <div class="nav-tab" data-tab="dashboard">üìä Wellness Dashboard</div>
        <div class="nav-tab" data-tab="history">üìù Emotional History</div>
      </div>

      <!-- Analysis Tab -->
      <div class="tab-content active" id="analysis-tab">
        {% if emotion %}
        <div class="emotion-badge">
          <i class="fas fa-heartbeat"></i>
          <span>Detected Emotion: {{ emotion|title }}</span>
        </div>
        {% endif %}

        <div class="analysis-section">
          <form method="post" action="{% url 'mental:predict_text' %}" id="mainForm">
            {% csrf_token %}
            <div class="input-container">
              <textarea name="text" id="userText" rows="4" placeholder="How are you feeling today? Share your thoughts, emotions, or anything on your mind...">{{ user_text }}</textarea>
              <div class="char-count"><span id="charCount">0</span>/500</div>
            </div>
            <button type="submit">
              <i class="fas fa-robot"></i> Analyze My Emotions
            </button>
          </form>

          {% if error %}
          <div class="error">
            <i class="fas fa-exclamation-circle"></i> {{ error }}
          </div>
          {% endif %}
        </div>

        <!-- Progress Indicator -->
        {% if prediction %}
        <div class="analysis-progress">
          <div class="progress-step completed">
            <i class="fas fa-check-circle"></i>
            <span>Text Analysis</span>
          </div>
          <div class="progress-step {% if quiz_completed %}completed{% else %}active{% endif %}">
            <i class="fas {% if quiz_completed %}fa-check-circle{% else %}fa-spinner{% endif %}"></i>
            <span>Detailed Assessment</span>
          </div>
          <div class="progress-step {% if conclusion %}completed{% else %}{% endif %}">
            <i class="fas {% if conclusion %}fa-check-circle{% else %}fa-chart-line{% endif %}"></i>
            <span>Final Report</span>
          </div>
        </div>
        {% endif %}

        <!-- Results Grid -->
        {% if prediction %}
        <div class="results-grid">
          <div class="score-card">
            <div class="score-header">
              <div>
                <div class="score-label">Emotional State</div>
                <div class="score-value">{{ prediction|title }}</div>
              </div>
              <div class="emotion-icon">
                {% if emotion == 'joy' %} üòä
                {% elif emotion == 'sadness' %} üò¢
                {% elif emotion == 'fear' %} üò®
                {% elif emotion == 'anger' %} üò†
                {% elif emotion == 'love' %} ‚ù§Ô∏è
                {% elif emotion == 'stress' %} üò©
                {% else %} üòê
                {% endif %}
              </div>
            </div>
            <div class="score-bar">
              <div class="score-fill" style="width: {{ score_percent }}%;"></div>
            </div>
          </div>
          
          <div class="score-card">
            <div class="score-header">
              <div>
                <div class="score-label">Current Mood Score</div>
                <div class="score-value">{{ mood_score|floatformat:1 }}/10</div>
              </div>
              <i class="fas fa-chart-line" style="font-size: 2rem; color: var(--primary);"></i>
            </div>
            <div class="score-bar">
              <div class="score-fill" style="width: {{ score_percent }}%;"></div>
            </div>
          </div>

          <div class="score-card">
            <div class="score-header">
              <div>
                <div class="score-label">Average Mood Score</div>
                <div class="score-average">{{ average_score|floatformat:1 }}/10</div>
              </div>
              <i class="fas fa-chart-bar" style="font-size: 2rem; color: var(--secondary);"></i>
            </div>
            <div class="score-bar">
              <div class="score-fill" style="width: {{ average_score|floatformat:0 }}%;"></div>
            </div>
          </div>
        </div>

        <!-- Wellness Score -->
        {% if wellness_score %}
        <div class="wellness-score">
          <h3><i class="fas fa-star"></i> Overall Wellness Score</h3>
          <div class="score">{{ wellness_score|floatformat:1 }}/10</div>
          <p>Based on your recent emotional patterns and stability</p>
        </div>
        {% endif %}

        <!-- Conclusion Section -->
        {% if conclusion %}
        <div class="conclusion-section">
          <h3><i class="fas fa-file-medical-alt"></i> Comprehensive Analysis</h3>
          <div class="conclusion-text">
            {{ conclusion }}
          </div>
        </div>
        {% endif %}

        <!-- Recommendations -->
        {% if recommendations %}
        <div class="recommendations">
          <h3><i class="fas fa-lightbulb"></i> Personalized Recommendations</h3>
          <div class="recommendations-grid">
            {% for rec in recommendations %}
            <div class="recommendation-card">
              <i class="fas fa-check-circle" style="color: var(--secondary); margin-bottom: 10px;"></i>
              <p>{{ rec }}</p>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Daily Challenge -->
        {% if daily_challenge %}
        <div class="daily-challenge">
          <h3><i class="fas fa-trophy"></i> Today's Wellness Challenge</h3>
          <div class="challenge-content">
            <div class="challenge-icon">
              <i class="fas fa-bullseye"></i>
            </div>
            <div>
              <h4>{{ daily_challenge.challenge }}</h4>
              <p><strong>Benefit:</strong> {{ daily_challenge.benefit }}</p>
              <p><strong>Time:</strong> {{ daily_challenge.estimated_time }}</p>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Quiz Section -->
        {% if quiz and not quiz_completed %}
        <div class="quiz-section">
          <h3><i class="fas fa-question-circle"></i> Detailed Self-Assessment</h3>
          <p class="quiz-description">
            Help us understand your emotional state better by answering these questions. 
            Your responses will help provide more accurate recommendations.
          </p>
          
          <form method="post" action="{% url 'mental:submit_quiz' %}">
            {% csrf_token %}
            <input type="hidden" name="original_text" value="{{ user_text }}">
            
            {% for q in quiz %}
            <div class="quiz-question">
              <p>{{ q.question }}</p>
              <div class="quiz-options">
                {% for opt in q.options %}
                <label>
                  <input type="radio" name="quiz_q{{ forloop.parentloop.counter }}" value="{{ opt }}" required>
                  <span>{{ opt }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
            
            <div class="quiz-submit">
              <button type="submit" class="btn-secondary">
                <i class="fas fa-paper-plane"></i> Submit Assessment
              </button>
            </div>
          </form>
        </div>
        {% endif %}
        {% endif %}
      </div>

      <!-- Chatbot Tab -->
      <div class="tab-content" id="chatbot-tab">
        <div class="chatbot-section">
          <h3><i class="fas fa-comments"></i> Therapeutic Chat Companion</h3>
          <p class="quiz-description">
            Chat with our AI therapeutic companion for real-time support, guided exercises, 
            and evidence-based techniques to help you navigate your emotions.
          </p>
          
          <div class="chat-messages" id="chatMessages">
            <div class="message bot">
              <div class="message-bubble">
                Hello! I'm here to support you. How are you feeling today?
              </div>
            </div>
          </div>
          
          <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Type your message here..." maxlength="500">
            <button onclick="sendMessage()">
              <i class="fas fa-paper-plane"></i> Send
            </button>
          </div>
        </div>
      </div>

      <!-- Dashboard Tab -->
      <div class="tab-content" id="dashboard-tab">
        <div class="analysis-section">
          <h3><i class="fas fa-chart-pie"></i> Wellness Dashboard</h3>
          
          {% if wellness_score %}
          <div class="wellness-score">
            <div class="score">{{ wellness_score|floatformat:1 }}/10</div>
            <p>Overall Wellness Score</p>
          </div>
          {% endif %}

          <div class="dashboard-grid">
            <div class="dashboard-card">
              <h4>Average Mood</h4>
              <div class="value">{{ average_score|floatformat:1 }}/10</div>
            </div>
            <div class="dashboard-card">
              <h4>Total Entries</h4>
              <div class="value">{{ entries|length }}</div>
            </div>
            <div class="dashboard-card">
              <h4>Best Time of Day</h4>
              <div class="value">
                {% if emotion_patterns.best_time_of_day %}
                  {{ emotion_patterns.best_time_of_day }}:00
                {% else %}
                  N/A
                {% endif %}
              </div>
            </div>
            <div class="dashboard-card">
              <h4>Dominant Emotion</h4>
              <div class="value">{{ emotion_patterns.dominant_emotion|title }}</div>
            </div>
          </div>

          {% if entries|length > 0 %}
          <div class="chart-container">
            <div class="chart-header">
              <h3><i class="fas fa-chart-line"></i> Mood Trend Analysis</h3>
              <span>Last {{ entries|length }} entries</span>
            </div>
            <canvas id="moodChart"></canvas>
          </div>

          <div class="chart-container">
            <div class="chart-header">
              <h3><i class="fas fa-chart-bar"></i> Emotion Distribution</h3>
            </div>
            <canvas id="emotionChart"></canvas>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- History Tab -->
      <div class="tab-content" id="history-tab">
        <div class="entries">
          <div class="entries-header">
            <h2><i class="fas fa-history"></i> Emotional History</h2>
            <span class="entries-count">{{ entries|length }} entries</span>
          </div>
          
          {% for entry in entries %}
          <div class="entry 
            {% if entry.mood_score < 3.5 %}negative
            {% elif entry.mood_score <= 6.5 %}neutral
            {% else %}positive
            {% endif %}" data-entry-id="{{ entry.id }}">
            <div class="entry-content">
              <div class="entry-meta">
                <span class="entry-date">{{ entry.created_at|date:"M d, Y H:i" }}</span>
                <span class="entry-emotion">{{ entry.prediction|title }}</span>
                <!-- Edit / Delete controls -->
                <span class="entry-controls" style="float:right;">
                  <button onclick="editEntry('{{ entry.id }}')" class="btn-gray btn-edit" title="Edit entry">
                    <i class="fas fa-paint-brush" aria-hidden="true"></i>
                    <span class="sr-only">Edit</span>
                  </button>
                  <button onclick="deleteEntry('{{ entry.id }}')" class="btn-gray btn-delete" title="Delete entry">
                    <i class="fas fa-trash-alt" aria-hidden="true"></i>
                    <span class="sr-only">Delete</span>
                  </button>
                </span>
              </div>
              <p class="entry-text">{{ entry.text }}</p>
              {% if entry.conclusion %}
              <div class="conclusion-text" style="margin-top: 10px; font-size: 0.9rem;">
                <strong>Analysis:</strong> {{ entry.conclusion }}
              </div>
              {% endif %}
              <div class="entry-stats">
                {% if entry.tags %}
                <div class="entry-stat">
                  <i class="fas fa-tags"></i> {{ entry.tags }}
                </div>
                {% endif %}
                {% if entry.sentiment_score %}
                <div class="entry-stat">
                  <i class="fas fa-smile"></i> Sentiment: {{ entry.sentiment_score|floatformat:2 }}
                </div>
                {% endif %}
                {% if entry.daily_challenge %}
                <div class="entry-stat">
                  <i class="fas fa-trophy"></i> Challenge: {{ entry.daily_challenge.challenge|truncatewords:5 }}
                </div>
                {% endif %}
              </div>
            </div>
            <div class="entry-score">
              <div class="score-circle">{{ entry.mood_score|floatformat:1 }}</div>
            </div>
          </div>
          {% empty %}
          <div class="empty-state">
            <i class="fas fa-comment-dots"></i>
            <h3>No entries yet</h3>
            <p>Start by sharing your thoughts above to track your emotional journey.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div class="modal-backdrop" onclick="closeEditModal()" aria-hidden="true"></div>
<div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title" id="editModalTitle"><i class="fas fa-pen"></i> Edit entry</div>
      <button onclick="closeEditModal()" class="btn-gray" aria-label="Close edit dialog"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editEntryId" value="">
      <label class="modal-label" for="editText">Your entry</label>
      <textarea id="editText" placeholder="Edit your thoughts..."></textarea>

      <div class="modal-row">
        <div style="flex:1">
          <label class="modal-label" for="editEmotion">Emotion</label>
          <select id="editEmotion" style="width:100%; padding:8px; border-radius:8px; border:1px solid #e6edf3; background:#fff;">
            <option value="">(auto)</option>
            <option value="joy">Joy</option>
            <option value="sadness">Sadness</option>
            <option value="anxiety">Anxiety</option>
            <option value="stress">Stress</option>
            <option value="anger">Anger</option>
            <option value="neutral">Neutral</option>
            <option value="love">Love</option>
            <option value="calm">Calm</option>
          </select>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
        <button type="button" class="btn-save" onclick="saveEdit()">Save changes</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Character counter for textarea
    const textarea = document.querySelector('textarea');
    const charCount = document.getElementById('charCount');
    
    if (textarea && charCount) {
      charCount.textContent = textarea.value.length;
      
      textarea.addEventListener('input', function() {
        charCount.textContent = this.value.length;
      });
    }
    
    // Animate score bars
    const fillBars = document.querySelectorAll('.score-fill');
    fillBars.forEach(bar => {
      bar.style.width = '0';
      setTimeout(() => {
        bar.style.width = bar.style.width;
      }, 100);
    });
    
    // Quiz selection styling
    const quizLabels = document.querySelectorAll('.quiz-options label');
    quizLabels.forEach(label => {
      label.addEventListener('click', function() {
        // Remove selected class from all labels in this question
        const questionLabels = this.closest('.quiz-options').querySelectorAll('label');
        questionLabels.forEach(l => l.classList.remove('selected'));
        
        // Add selected class to clicked label
        this.classList.add('selected');
      });
    });
    
    // Tab navigation
    const tabs = document.querySelectorAll('.nav-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab') + '-tab';
        
        // Remove active class from all tabs and contents
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        document.getElementById(tabId).classList.add('active');
      });
    });
    
    // Chat functionality
    window.sendMessage = function() {
      const input = document.getElementById('chatInput');
      const messages = document.getElementById('chatMessages');
      const message = input.value.trim();
      
      if (message) {
        // Add user message
        const userMessage = document.createElement('div');
        userMessage.className = 'message user';
        userMessage.innerHTML = `
          <div class="message-bubble">${message}</div>
        `;
        messages.appendChild(userMessage);
        
        // Clear input
        input.value = '';
        
        // Scroll to bottom
        messages.scrollTop = messages.scrollHeight;
        
        // Send message to backend chat endpoint and append bot response
        setTimeout(() => {
          fetch("{% url 'mental:chat_with_bot' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams({ message })
          })
          .then(res => {
            const ct = res.headers.get('content-type') || '';
            if (res.ok && ct.includes('application/json')) {
              return res.json().then(data => ({ ok: true, data }));
            }
            // If it's not JSON, return the text so we can surface a helpful error
            return res.text().then(text => ({ ok: res.ok, text }));
          })
          .then(payload => {
            if (payload.ok && payload.data) {
              const botMessage = document.createElement('div');
              botMessage.className = 'message bot';
              botMessage.innerHTML = `\n                <div class="message-bubble">${payload.data.bot_response}</div>\n              `;
              messages.appendChild(botMessage);
              messages.scrollTop = messages.scrollHeight;
            } else {
              const errText = payload.text || 'Sorry, something went wrong. Please try again.';
              const botMessage = document.createElement('div');
              botMessage.className = 'message bot';
              botMessage.innerHTML = `\n                <div class="message-bubble">${errText}</div>\n              `;
              messages.appendChild(botMessage);
              messages.scrollTop = messages.scrollHeight;
              console.error('Chat request failed', payload.text || payload);
            }
          })
          .catch(err => {
            const botMessage = document.createElement('div');
            botMessage.className = 'message bot';
            botMessage.innerHTML = `\n              <div class="message-bubble">Sorry, I couldn't reach the server. Please try again later.</div>\n            `;
            messages.appendChild(botMessage);
            messages.scrollTop = messages.scrollHeight;
            console.error('Chat request failed', err);
          });
        }, 300);
      }
    }
    
    // Enter key for chat
    document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Edit an entry using a modern modal card
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    window.editEntry = function(id) {
      const container = document.querySelector(`[data-entry-id="${id}"]`);
      if (!container) return alert('Entry not found in DOM');

      const textEl = container.querySelector('.entry-text');
      const current = textEl ? textEl.innerText : '';
      const emotionEl = container.querySelector('.entry-emotion');
      const emotionCurrent = emotionEl ? emotionEl.innerText.toLowerCase() : '';

      // Populate modal fields
      document.getElementById('editEntryId').value = id;
      document.getElementById('editText').value = current;
      document.getElementById('editEmotion').value = emotionCurrent;

      // Show modal
      document.querySelector('.modal-backdrop').classList.add('show');
      document.getElementById('editModal').classList.add('show');
      document.getElementById('editText').focus();
    }

    window.closeEditModal = function() {
      document.querySelector('.modal-backdrop').classList.remove('show');
      document.getElementById('editModal').classList.remove('show');
    }

    window.saveEdit = function() {
      const id = document.getElementById('editEntryId').value;
      const newText = document.getElementById('editText').value.trim();
      const newEmotion = document.getElementById('editEmotion').value;
      if (!id) return alert('Missing entry id');

      const params = new URLSearchParams({ id: id, text: newText });
      if (newEmotion) params.append('emotion', newEmotion);

      fetch("{% url 'mental:edit_entry' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken') || ''
        },
        body: params
      })
      .then(r => r.json())
      .then(res => {
        if (res.error) return alert(res.error);
        const updated = res.updated;

        const container = document.querySelector(`[data-entry-id="${id}"]`);
        if (container) {
          const textEl = container.querySelector('.entry-text');
          if (textEl) textEl.innerText = updated.text;

          const emotionEl = container.querySelector('.entry-emotion');
          if (emotionEl) emotionEl.innerText = updated.prediction ? updated.prediction.charAt(0).toUpperCase() + updated.prediction.slice(1) : (updated.emotion || '');

          const scoreEl = container.querySelector('.score-circle');
          if (scoreEl) scoreEl.innerText = parseFloat(updated.mood_score).toFixed(1);

          const concl = container.querySelector('.conclusion-text');
          if (concl) concl.innerHTML = `<strong>Analysis:</strong> ${updated.conclusion}`;
        }

        closeEditModal();
      })
      .catch(err => {
        console.error('Edit failed', err);
        alert('Edit failed. See console for details.');
      });
    }

    // Delete an entry
    window.deleteEntry = function(id) {
      if (!confirm('Are you sure you want to delete this entry?')) return;
      const container = document.querySelector(`[data-entry-id="${id}"]`);
  fetch("{% url 'mental:delete_entry' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams({ id: id })
      })
      .then(r => r.json())
      .then(res => {
        if (res.error) return alert(res.error);
        // remove from DOM
        if (container) container.remove();
        // update entries count
        const count = document.querySelector('.entries-count');
        if (count) count.innerText = `${res.remaining} entries`;
      })
      .catch(err => {
        console.error('Delete failed', err);
        alert('Delete failed. See console for details.');
      });
    }
    
    // Mood chart
    const moodCtx = document.getElementById('moodChart');
    if (moodCtx && {{ entries|length }} > 0) {
      const moodData = {
        labels: [{% for e in entries %}"{{ e.created_at|date:'M d' }}",{% endfor %}],
        datasets: [{
          label: 'Mood Score',
          data: [{% for e in entries %}{{ e.mood_score }},{% endfor %}],
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#6366f1',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      };
      
      new Chart(moodCtx, {
        type: 'line',
        data: moodData,
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 10,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Mood Score'
              }
            },
            x: {
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Date'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              padding: 10,
              cornerRadius: 8
            }
          }
        }
      });
    }
    
    // Emotion distribution chart
    const emotionCtx = document.getElementById('emotionChart');
    if (emotionCtx && {{ entries|length }} > 0) {
      const emotionData = {
        labels: Object.keys({{ emotion_patterns.emotion_distribution|default:"{}"|safe }}),
        datasets: [{
          data: Object.values({{ emotion_patterns.emotion_distribution|default:"{}"|safe }}),
          backgroundColor: [
            '#6366f1', '#06d6a0', '#ef476f', '#ffd166', '#118ab2', '#073b4c'
          ],
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      };
      
      new Chart(emotionCtx, {
        type: 'doughnut',
        data: emotionData,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
  });
</script>
</body>
</html>