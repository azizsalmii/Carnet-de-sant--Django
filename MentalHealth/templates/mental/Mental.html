{% extends 'journal/base.html' %}
{% load static %}

{% block content %}

<!-- MindCare ‚Äî styles locaux (on les garde ici pour rester autonome) -->
<style>
  :root {
    --primary: #06d6a0; --primary-light: #818cf8; --primary-dark: #4f46e5;
    --secondary: #06d6a0; --danger: #ef476f; --warning: #ffd166; --info: #118ab2;
    --bg: #f8fafc; --card-bg: #ffffff; --text: #1e293b; --text-light: #64748b; --border: #e2e8f0;
    --shadow: 0 10px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
    --shadow-hover: 0 20px 40px -10px rgba(0,0,0,.15);
    --gradient: linear-gradient(135deg, var(--primary), var(--primary-light));
    --gradient-secondary: linear-gradient(135deg, var(--secondary), #07c290);
    --gradient-warning: linear-gradient(135deg, var(--warning), #ffb347);
  }
  .main-app{background:var(--card-bg);border-radius:24px;box-shadow:var(--shadow);overflow:hidden;position:relative;margin-bottom:30px}
  .app-header{background:var(--gradient);color:#fff;padding:40px;text-align:center;position:relative;overflow:hidden}
  .app-header::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24  5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1'/%3E%3C/svg%3E");opacity:.3}
  .app-content{padding:40px}
  .nav-tabs{display:flex;background:var(--bg);border-radius:16px;padding:8px;margin-bottom:30px;border:1px solid var(--border)}
  .nav-tab{flex:1;padding:15px 20px;text-align:center;border-radius:12px;cursor:pointer;transition:.3s;font-weight:500;color:var(--text-light)}
  .nav-tab.active{background:var(--gradient);color:#fff;box-shadow:var(--shadow)}
  .tab-content{display:none}.tab-content.active{display:block;animation:fadeIn .5s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .analysis-section{background:#fff;border-radius:20px;padding:30px;margin-bottom:30px;border:1px solid var(--border);box-shadow:var(--shadow)}
  .emotion-badge{display:inline-flex;align-items:center;gap:10px;background:var(--gradient);color:#fff;padding:12px 24px;border-radius:50px;font-weight:600;margin:0 auto 30px;box-shadow:var(--shadow)}
  .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:25px;margin:30px 0}
  .score-card{background:#fff;border-radius:20px;padding:25px;box-shadow:var(--shadow);border:1px solid var(--border);position:relative;overflow:hidden}
  .score-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--gradient)}
  .score-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
  .score-value{font-size:2.5rem;font-weight:700;color:var(--primary)}
  .score-average{font-size:1.8rem;font-weight:700;color:var(--secondary)}
  .score-label{color:var(--text-light);font-weight:500;font-size:.9rem}
  .score-bar{width:100%;background:#e2e8f0;border-radius:10px;height:12px;margin-top:15px;overflow:hidden}
  .score-fill{height:100%;background:var(--gradient);width:0;border-radius:10px;transition:width 1.2s ease-in-out}
  .wellness-score{text-align:center;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:20px;margin:20px 0}
  .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:25px 0}
  .dashboard-card{background:#fff;padding:20px;border-radius:16px;box-shadow:var(--shadow);border-left:4px solid var(--primary)}
  .conclusion-section{background:linear-gradient(135deg,#f0f4ff,#e6f0ff);border-radius:20px;padding:30px;margin:25px 0;border-left:5px solid var(--primary)}
  .conclusion-text{font-size:1.1rem;line-height:1.6;color:var(--text);background:#fff;padding:25px;border-radius:16px;border-left:4px solid var(--secondary);box-shadow:var(--shadow)}
  .recommendations{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:20px;padding:30px;margin:25px 0;border-left:5px solid var(--primary)}
  .recommendations-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
  .recommendation-card{background:#fff;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border)}
  .daily-challenge{background:linear-gradient(135deg,#fff9f0,#fff4e6);border-radius:20px;padding:25px;margin:25px 0;border-left:5px solid var(--warning)}
  .chatbot-section{background:#fff;border-radius:20px;padding:25px;margin:25px 0;box-shadow:var(--shadow);border:1px solid var(--border)}
  .chat-messages{height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px;background:#fafafa}
  .message{margin-bottom:15px;display:flex;gap:10px}.message.user{justify-content:flex-end}
  .message-bubble{max-width:70%;padding:12px 16px;border-radius:18px;font-size:.95rem}
  .message.bot .message-bubble{background:#fff;border:1px solid var(--border);border-bottom-left-radius:4px}
  .message.user .message-bubble{background:var(--gradient);color:#fff;border-bottom-right-radius:4px}
  .entries{margin-top:40px}.entry{background:#fff;border-radius:16px;margin-bottom:20px;padding:25px;box-shadow:var(--shadow);border-left:5px solid var(--primary);display:grid;grid-template-columns:1fr auto;gap:20px}
  .entry.negative{border-left-color:var(--danger)}.entry.neutral{border-left-color:var(--warning)}.entry.positive{border-left-color:var(--secondary)}
  .entry-meta{display:flex;align-items:center;gap:15px;margin-bottom:12px;flex-wrap:wrap}
  .entry-emotion{background:var(--primary-light);color:#fff;padding:6px 14px;border-radius:20px;font-size:.85rem;font-weight:500}
  .entry.negative .entry-emotion{background:var(--danger)}.entry.neutral .entry-emotion{background:var(--warning);color:#333}.entry.positive .entry-emotion{background:var(--secondary)}
  .score-circle{width:70px;height:70px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.3rem;background:var(--gradient);color:#fff;box-shadow:var(--shadow)}
  .error{background:#fef2f2;color:var(--danger);padding:20px;border-radius:16px;margin:20px 0;text-align:center;font-weight:500;border-left:4px solid var(--danger);box-shadow:var(--shadow)}
  .success{background:#f0f9ff;color:var(--primary);padding:20px;border-radius:16px;margin:20px 0;text-align:center;font-weight:500;border-left:4px solid var(--primary);box-shadow:var(--shadow)}
  .btn{background:var(--gradient);color:#fff;border:none;padding:16px 32px;border-radius:12px;font-weight:600;cursor:pointer;transition:.3s;font-size:1rem;display:inline-flex;align-items:center;gap:10px;box-shadow:var(--shadow)}
  .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover)}
  .btn-secondary{background:var(--gradient-secondary)}
  .btn-warning{background:var(--gradient-warning)}
  .btn-gray{background:linear-gradient(180deg,#f3f4f6 0%,#e9ecef 100%);color:#111827;border:1px solid #d1d5db;padding:8px 12px;border-radius:10px;font-weight:600;display:inline-flex;gap:8px;box-shadow:0 6px 14px rgba(15,23,42,.06)}
  .btn-delete i{color:#dc2626}
  @media(max-width:768px){
    .app-content{padding:20px}.results-grid,.recommendations-grid{grid-template-columns:1fr}
    .entry{grid-template-columns:1fr;text-align:center}.message-bubble{max-width:85%}


/* --- Formulaire √©troit et pro --- */
.form-narrow{
  width: 100%;
  max-width: 560px;          /* r√®gle l‚Äô√©troitesse (520‚Äì600px marche bien) */
  margin-inline: auto;       /* centre proprement */
}

.input-container textarea{
  min-height: 130px;         /* hauteur confortable */
  resize: vertical;          /* autorise seulement la hauteur */
  border-radius: 14px;
  padding: 18px 20px;
  line-height: 1.55;
  border: 1.5px solid var(--border);
  box-shadow: 0 2px 10px rgba(2,6,23,.04);
}

.input-container textarea:focus{
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(99,102,241,.08), 0 6px 20px rgba(2,6,23,.08);
}

.input-meta{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-top: 8px;
  font-size: .88rem;
  color: var(--text-light);
}

/* bouton align√© √† gauche dans la colonne √©troite */
.form-narrow button[type="submit"]{
  margin-top: 14px;
}

/* Responsive : un peu plus √©troit sur mobile pour l‚Äô√©quilibre */
@media (max-width: 768px){
  .form-narrow{ max-width: 92%; }
}


  }
</style>

<div class="main-app">
  <!-- Header local (le header global du site vient de base.html ; ici c‚Äôest la banni√®re de la page) -->
  <div class="app-header">
    <h1><i class="fas fa-brain"></i> MindCare</h1>
    <p class="tagline">Your Intelligent AI Mental Health Companion</p>
  </div>

  <div class="app-content">
    <!-- Onglets -->
    <div class="nav-tabs">
      <div class="nav-tab {% if not active_tab or active_tab == 'analysis' %}active{% endif %}" data-tab="analysis">üß† Emotional Analysis</div>
      <div class="nav-tab {% if active_tab == 'chatbot' %}active{% endif %}" data-tab="chatbot">ü§ñ Therapeutic Chat</div>
      <div class="nav-tab {% if active_tab == 'dashboard' %}active{% endif %}" data-tab="dashboard">üìä Wellness Dashboard</div>
      <div class="nav-tab {% if active_tab == 'history' %}active{% endif %}" data-tab="history">üìù Emotional History</div>
    </div>

    <!-- Analysis -->
    <div class="tab-content {% if not active_tab or active_tab == 'analysis' %}active{% endif %}" id="analysis-tab">
      {% if emotion %}
      <div class="emotion-badge">
        <i class="fas fa-heartbeat"></i>
        <span>Detected Emotion: {{ emotion|title }}</span>
      </div>
      {% endif %}

      <div class="analysis-section">
        <form method="post" action="{% url 'mental:predict_text' %}" id="mainForm">
          {% csrf_token %}
          <div class="input-container">
            <textarea name="text" id="userText" rows="4" placeholder="How are you feeling today? Share your thoughts...">{{ user_text }}</textarea>
            <div class="char-count"><span id="charCount">0</span>/500</div>
          </div>
          <button type="submit" class="btn"><i class="fas fa-robot"></i> Analyze My Emotions</button>
        </form>

        {% if error %}
        <div class="error"><i class="fas fa-exclamation-circle"></i> {{ error }}</div>
        {% endif %}
      </div>

      {% if prediction %}
      <div class="analysis-progress" style="display:flex;align-items:center;gap:20px;justify-content:center;background:var(--bg);border:1px solid var(--border);border-radius:16px;padding:20px;">
        <div class="progress-step completed"><i class="fas fa-check-circle"></i> <span>Text Analysis</span></div>
        <div class="progress-step {% if quiz_completed %}completed{% else %}active{% endif %}"><i class="fas {% if quiz_completed %}fa-check-circle{% else %}fa-spinner{% endif %}"></i> <span>Detailed Assessment</span></div>
        <div class="progress-step {% if conclusion %}completed{% endif %}"><i class="fas {% if conclusion %}fa-check-circle{% else %}fa-chart-line{% endif %}"></i> <span>Final Report</span></div>
      </div>

      <div class="results-grid">
        <div class="score-card">
          <div class="score-header">
            <div>
              <div class="score-label">Emotional State</div>
              <div class="score-value">{{ prediction|title }}</div>
            </div>
            <div class="emotion-icon">
              {% if emotion == 'joy' %} üòä
              {% elif emotion == 'sadness' %} üò¢
              {% elif emotion == 'fear' %} üò®
              {% elif emotion == 'anger' %} üò†
              {% elif emotion == 'love' %} ‚ù§Ô∏è
              {% elif emotion == 'stress' %} üò©
              {% else %} üòê
              {% endif %}
            </div>
          </div>
          <div class="score-bar"><div class="score-fill" style="width: {{ score_percent }}%;"></div></div>
        </div>

        <div class="score-card">
          <div class="score-header">
            <div>
              <div class="score-label">Current Mood Score</div>
              <div class="score-value">{{ mood_score|floatformat:1 }}/10</div>
            </div>
            <i class="fas fa-chart-line" style="font-size:2rem;color:var(--primary);"></i>
          </div>
          <div class="score-bar"><div class="score-fill" style="width: {{ score_percent }}%;"></div></div>
        </div>

        <div class="score-card">
          <div class="score-header">
            <div>
              <div class="score-label">Average Mood Score</div>
              <div class="score-average">{{ average_score|floatformat:1 }}/10</div>
            </div>
            <i class="fas fa-chart-bar" style="font-size:2rem;color:var(--secondary);"></i>
          </div>
          <div class="score-bar"><div class="score-fill" style="width: {{ average_score|floatformat:0 }}%;"></div></div>
        </div>
      </div>

      {% if wellness_score %}
      <div class="wellness-score">
        <h3><i class="fas fa-star"></i> Overall Wellness Score</h3>
        <div class="score">{{ wellness_score|floatformat:1 }}/10</div>
        <p>Based on your recent emotional patterns and stability</p>
      </div>
      {% endif %}

      {% if conclusion %}
      <div class="conclusion-section">
        <h3><i class="fas fa-file-medical-alt"></i> Comprehensive Analysis</h3>
        <div class="conclusion-text">{{ conclusion }}</div>
      </div>
      {% endif %}

      {% if recommendations %}
      <div class="recommendations">
        <h3><i class="fas fa-lightbulb"></i> Personalized Recommendations</h3>
        <div class="recommendations-grid">
          {% for rec in recommendations %}
          <div class="recommendation-card">
            <i class="fas fa-check-circle" style="color:var(--secondary);margin-bottom:10px;"></i>
            <p>{{ rec }}</p>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if daily_challenge %}
      <div class="daily-challenge">
        <h3><i class="fas fa-trophy"></i> Today's Wellness Challenge</h3>
        <div class="challenge-content" style="display:flex;align-items:center;gap:20px;">
          <div class="challenge-icon"><i class="fas fa-bullseye"></i></div>
          <div>
            <h4>{{ daily_challenge.challenge }}</h4>
            <p><strong>Benefit:</strong> {{ daily_challenge.benefit }}</p>
            <p><strong>Time:</strong> {{ daily_challenge.estimated_time }}</p>
          </div>
        </div>
      </div>
      {% endif %}

      {% if quiz and not quiz_completed %}
      <div class="quiz-section">
        <h3><i class="fas fa-question-circle"></i> Detailed Self-Assessment</h3>
        <p class="quiz-description">Answer these quick questions to refine your analysis.</p>

        <form method="post" action="{% url 'mental:submit_quiz' %}">
          {% csrf_token %}
          <input type="hidden" name="original_text" value="{{ user_text }}">
          {% for q in quiz %}
          <div class="quiz-question" style="margin-bottom:25px;border-bottom:1px solid var(--border);padding-bottom:20px;">
            <p style="font-weight:600;color:var(--text)">{{ q.question }}</p>
            <div class="quiz-options" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
              {% for opt in q.options %}
              <label style="display:flex;align-items:center;gap:10px;padding:15px;border-radius:12px;border:2px solid var(--border);background:#fff;cursor:pointer;">
                <input type="radio" name="quiz_q{{ forloop.parentloop.counter }}" value="{{ opt }}" required>
                <span>{{ opt }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
          <div style="text-align:center">
            <button type="submit" class="btn btn-secondary"><i class="fas fa-paper-plane"></i> Submit Assessment</button>
          </div>
        </form>
      </div>
      {% endif %}
      {% endif %}
    </div>

    <!-- Chatbot -->
    <div class="tab-content {% if active_tab == 'chatbot' %}active{% endif %}" id="chatbot-tab">
      <div class="chatbot-section">
        <h3><i class="fas fa-comments"></i> Therapeutic Chat Companion</h3>
        <p class="quiz-description">Chat with our AI companion for real-time support.</p>

        <div class="chat-messages" id="chatMessages">
          <div class="message bot"><div class="message-bubble">Hello! I'm here to support you. How are you feeling today?</div></div>
        </div>
        <div class="chat-input" style="display:flex;gap:10px">
          <input type="text" id="chatInput" placeholder="Type your message here..." maxlength="500" style="flex:1;padding:15px;border:2px solid var(--border);border-radius:12px;">
          <button onclick="sendMessage()" class="btn"><i class="fas fa-paper-plane"></i> Send</button>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="tab-content {% if active_tab == 'dashboard' %}active{% endif %}" id="dashboard-tab">
      <div class="analysis-section">
        <h3><i class="fas fa-chart-pie"></i> Wellness Dashboard</h3>

        {% if wellness_score %}
        <div class="wellness-score">
          <div class="score">{{ wellness_score|floatformat:1 }}/10</div>
          <p>Overall Wellness Score</p>
        </div>
        {% endif %}

        <div class="dashboard-grid">
          <div class="dashboard-card"><h4>Average Mood</h4><div class="value">{{ average_score|floatformat:1 }}/10</div></div>
          <div class="dashboard-card"><h4>Total Entries</h4><div class="value">{{ entries|length }}</div></div>
          <div class="dashboard-card"><h4>Best Time of Day</h4><div class="value">{% if emotion_patterns.best_time_of_day %}{{ emotion_patterns.best_time_of_day }}:00{% else %}N/A{% endif %}</div></div>
          <div class="dashboard-card"><h4>Dominant Emotion</h4><div class="value">{{ emotion_patterns.dominant_emotion|title }}</div></div>
        </div>

        {% if entries|length > 0 %}
        <div class="chart-container" style="margin-top:40px;background:#fff;border-radius:20px;padding:30px;box-shadow:var(--shadow);border:1px solid var(--border)">
          <div class="chart-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px">
            <h3><i class="fas fa-chart-line"></i> Mood Trend Analysis</h3>
            <span>Last {{ entries|length }} entries</span>
          </div>
          <canvas id="moodChart"></canvas>
        </div>

        <div class="chart-container" style="margin-top:40px;background:#fff;border-radius:20px;padding:30px;box-shadow:var(--shadow);border:1px solid var(--border)">
          <div class="chart-header"><h3><i class="fas fa-chart-bar"></i> Emotion Distribution</h3></div>
          <canvas id="emotionChart"></canvas>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- History -->
    <div class="tab-content {% if active_tab == 'history' %}active{% endif %}" id="history-tab">
      <div class="entries">
        <div class="entries-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px">
          <h2><i class="fas fa-history"></i> Emotional History</h2>
          <span class="entries-count">{{ entries|length }} entries</span>
        </div>

        {% for entry in entries %}
        <div class="entry
          {% if entry.mood_score < 3.5 %}negative
          {% elif entry.mood_score <= 6.5 %}neutral
          {% else %}positive
          {% endif %}" data-entry-id="{{ entry.id }}">
          <div class="entry-content">
            <div class="entry-meta">
              <span class="entry-date">{{ entry.created_at|date:"M d, Y H:i" }}</span>
              <span class="entry-emotion">{{ entry.prediction|title }}</span>
              <span class="entry-controls" style="margin-left:auto;display:inline-flex;gap:8px">
                <button onclick="editEntry('{{ entry.id }}')" class="btn-gray btn-edit" title="Edit entry"><i class="fas fa-paint-brush" aria-hidden="true"></i></button>
                <button onclick="deleteEntry('{{ entry.id }}')" class="btn-gray btn-delete" title="Delete entry"><i class="fas fa-trash-alt" aria-hidden="true"></i></button>
              </span>
            </div>
            <p class="entry-text">{{ entry.text }}</p>
            {% if entry.conclusion %}
            <div class="conclusion-text" style="margin-top:10px;font-size:.9rem;"><strong>Analysis:</strong> {{ entry.conclusion }}</div>
            {% endif %}
            <div class="entry-stats" style="display:flex;gap:20px;margin-top:15px;color:var(--text-light);font-size:.85rem">
              {% if entry.tags %}<div class="entry-stat"><i class="fas fa-tags"></i> {{ entry.tags }}</div>{% endif %}
              {% if entry.sentiment_score %}<div class="entry-stat"><i class="fas fa-smile"></i> Sentiment: {{ entry.sentiment_score|floatformat:2 }}</div>{% endif %}
              {% if entry.daily_challenge %}<div class="entry-stat"><i class="fas fa-trophy"></i> Challenge: {{ entry.daily_challenge.challenge|truncatewords:5 }}</div>{% endif %}
            </div>
          </div>
          <div class="entry-score"><div class="score-circle">{{ entry.mood_score|floatformat:1 }}</div></div>
        </div>
        {% empty %}
        <div class="empty-state" style="text-align:center;padding:60px 20px;color:var(--text-light)">
          <i class="fas fa-comment-dots" style="font-size:4rem;margin-bottom:20px;color:var(--border);opacity:.5"></i>
          <h3>No entries yet</h3>
          <p>Start by sharing your thoughts above to track your emotional journey.</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-backdrop" onclick="closeEditModal()" aria-hidden="true" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,.55);align-items:center;justify-content:center;z-index:9998"></div>
<div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title" id="editModalTitle"><i class="fas fa-pen"></i> Edit entry</div>
      <button onclick="closeEditModal()" class="btn-gray" aria-label="Close edit dialog"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editEntryId" value="">
      <label class="modal-label" for="editText">Your entry</label>
      <textarea id="editText" placeholder="Edit your thoughts..."></textarea>

      <div class="modal-row">
        <div style="flex:1">
          <label class="modal-label" for="editEmotion">Emotion</label>
          <select id="editEmotion" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf3;background:#fff;">
            <option value="">(auto)</option>
            <option value="joy">Joy</option><option value="sadness">Sadness</option>
            <option value="anxiety">Anxiety</option><option value="stress">Stress</option>
            <option value="anger">Anger</option><option value="neutral">Neutral</option>
            <option value="love">Love</option><option value="calm">Calm</option>
          </select>
        </div>
      </div>

      <div class="modal-actions"><button type="button" class="btn-cancel btn-gray" onclick="closeEditModal()">Cancel</button><button type="button" class="btn-save" onclick="saveEdit()">Save changes</button></div>
    </div>
  </div>
</div>

<!-- D√©pendances locales (Chart.js + Font Awesome si pas d√©j√† dans la base) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Compteur
    const textarea = document.getElementById('userText');
    const charCount = document.getElementById('charCount');
    if (textarea && charCount){ charCount.textContent = textarea.value.length; textarea.addEventListener('input', ()=> charCount.textContent = textarea.value.length); }

    // Tabs
    const tabs = document.querySelectorAll('.nav-tab'); const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.addEventListener('click', () => {
      const tabId = tab.getAttribute('data-tab') + '-tab';
      tabs.forEach(t => t.classList.remove('active')); tabContents.forEach(c => c.classList.remove('active'));
      tab.classList.add('active'); document.getElementById(tabId).classList.add('active');
    }));

    // Chat
    window.sendMessage = function () {
      const input = document.getElementById('chatInput'); const messages = document.getElementById('chatMessages'); const message = (input?.value || '').trim();
      if (!message) return;
      messages.insertAdjacentHTML('beforeend', `<div class="message user"><div class="message-bubble">${message}</div></div>`);
      input.value=''; messages.scrollTop = messages.scrollHeight;

      fetch("{% url 'mental:chat_with_bot' %}", {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','X-Requested-With':'XMLHttpRequest'},
        body: new URLSearchParams({ message })
      })
      .then(res => res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text().then(text => { throw new Error(text) }))
      .then(data => {
        messages.insertAdjacentHTML('beforeend', `<div class="message bot"><div class="message-bubble">${data.bot_response}</div></div>`);
        messages.scrollTop = messages.scrollHeight;
      })
      .catch(err => {
        messages.insertAdjacentHTML('beforeend', `<div class="message bot"><div class="message-bubble">Sorry, something went wrong.</div></div>`);
        console.error(err);
      });
    };
    document.getElementById('chatInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    // Edit modal helpers
    function showBackdrop(show){document.querySelector('.modal-backdrop').style.display = show?'flex':'none';document.getElementById('editModal').style.display = show?'flex':'none';}
    window.editEntry = function(id){
      const c = document.querySelector(`[data-entry-id="${id}"]`); if(!c) return;
      document.getElementById('editEntryId').value = id;
      document.getElementById('editText').value = c.querySelector('.entry-text')?.innerText || '';
      document.getElementById('editEmotion').value = (c.querySelector('.entry-emotion')?.innerText || '').toLowerCase();
      showBackdrop(true);
    };
    window.closeEditModal = function(){ showBackdrop(false); };

    function getCookie(name){ const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }

    window.saveEdit = function(){
      const id = document.getElementById('editEntryId').value;
      const newText = document.getElementById('editText').value.trim();
      const newEmotion = document.getElementById('editEmotion').value;
      const params = new URLSearchParams({ id, text: newText }); if(newEmotion) params.append('emotion', newEmotion);

      fetch("{% url 'mental:edit_entry' %}", {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','X-Requested-With':'XMLHttpRequest','X-CSRFToken': getCookie('csrftoken')},
        body: params
      }).then(r=>r.json()).then(res=>{
        if(res.error) return alert(res.error);
        const u = res.updated; const c = document.querySelector(`[data-entry-id="${id}"]`);
        if(c){
          c.querySelector('.entry-text').innerText = u.text;
          c.querySelector('.entry-emotion').innerText = (u.prediction || u.emotion || '').replace(/^./, m=>m.toUpperCase());
          c.querySelector('.score-circle').innerText = parseFloat(u.mood_score).toFixed(1);
          const concl = c.querySelector('.conclusion-text'); if(concl) concl.innerHTML = `<strong>Analysis:</strong> ${u.conclusion}`;
        }
        showBackdrop(false);
      }).catch(err=>{ console.error(err); alert('Edit failed'); });
    };

    window.deleteEntry = function(id){
      if(!confirm('Delete this entry?')) return;
      const c = document.querySelector(`[data-entry-id="${id}"]`);
      fetch("{% url 'mental:delete_entry' %}", {
        method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','X-Requested-With':'XMLHttpRequest'},
        body: new URLSearchParams({ id })
      }).then(r=>r.json()).then(res=>{
        if(res.error) return alert(res.error);
        if(c) c.remove();
        const count = document.querySelector('.entries-count'); if(count) count.innerText = `${res.remaining} entries`;
      }).catch(err=>{ console.error(err); alert('Delete failed'); });
    };

    // Charts
    const moodCtx = document.getElementById('moodChart');
    if (moodCtx && {{ entries|length }} > 0){
      new Chart(moodCtx, {
        type:'line',
        data:{ labels:[{% for e in entries %}"{{ e.created_at|date:'M d' }}",{% endfor %}],
               datasets:[{ label:'Mood Score', data:[{% for e in entries %}{{ e.mood_score }},{% endfor %}],
                 borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,.1)', fill:true, tension:.4,
                 pointBackgroundColor:'#6366f1', pointBorderColor:'#fff', pointBorderWidth:2, pointRadius:5, pointHoverRadius:7 }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:10 }, x:{ grid:{ display:false } } }, plugins:{ legend:{ display:false } } }
      });
    }

    const emotionCtx = document.getElementById('emotionChart');
    if (emotionCtx && {{ entries|length }} > 0){
      const dist = {{ emotion_patterns.emotion_distribution|default:"{}"|safe }};
      new Chart(emotionCtx, {
        type:'doughnut',
        data:{ labels:Object.keys(dist), datasets:[{ data:Object.values(dist), backgroundColor:['#6366f1','#06d6a0','#ef476f','#ffd166','#118ab2','#073b4c'], borderWidth:2, borderColor:'#fff' }] },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
      });
    }
  });
</script>

{% endblock %}
