# ğŸš€ Render Deployment Guide - Carnet de SantÃ© Django

Complete guide to deploying the AI-powered health tracking app to Render.com with PostgreSQL.

---

## ğŸ“‹ Table of Contents

1. [Prerequisites](#prerequisites)
2. [Deployment Files Overview](#deployment-files-overview)
3. [Step-by-Step Deployment](#step-by-step-deployment)
4. [Environment Variables](#environment-variables)
5. [Post-Deployment Testing](#post-deployment-testing)
6. [Troubleshooting](#troubleshooting)
7. [Useful Commands](#useful-commands)

---

## âœ… Prerequisites

- **GitHub Account**: Repository already set up at `github.com/azizsalmii/Carnet-de-sant--Django`
- **Render Account**: Sign up free at [render.com](https://render.com)
- **Branch**: `feature/ai-recommendations-improvements` (contains deployment configs)
- **Python Version**: 3.11.0
- **Deployment Time**: ~15-20 minutes

---

## ğŸ“¦ Deployment Files Overview

All these files have been created in your repository:

### 1. `build.sh` - Build Script
- Installs dependencies (core + AI/ML)
- Collects static files
- Runs database migrations
- Creates superuser (optional, via env vars)

### 2. `render.yaml` - Service Configuration
- Defines web service (Django app)
- Defines PostgreSQL database
- Links services together
- Sets environment variables

### 3. `requirements.txt` - Core Dependencies
- Django 5.2.7
- DRF (REST API)
- Gunicorn (WSGI server)
- PostgreSQL adapter
- WhiteNoise (static files)
- Production utilities

### 4. `requirements_ai.txt` - ML Dependencies
- NumPy, Pandas, Scikit-learn
- SciPy, Joblib
- ML model dependencies

### 5. `.env.example` - Environment Template
- Example environment variables
- Security settings
- Database config
- Superuser credentials

### 6. `projetPython/settings.py` - Updated
- Production-ready configuration
- Environment variable support (via `python-decouple`)
- PostgreSQL config (via `dj-database-url`)
- WhiteNoise static files
- Security settings for production

---

## ğŸš€ Step-by-Step Deployment

### Step 1: Push Deployment Files to GitHub

```bash
# Make build script executable
git update-index --chmod=+x build.sh

# Stage all deployment files
git add build.sh render.yaml requirements.txt requirements_ai.txt .env.example
git add projetPython/settings.py

# Commit
git commit -m "Add Render deployment configuration"

# Push to GitHub
git push origin feature/ai-recommendations-improvements
```

### Step 2: Connect Render to GitHub

1. Go to [render.com](https://render.com)
2. Click **Sign Up** or **Log In**
3. Choose **"Continue with GitHub"**
4. Authorize Render to access your GitHub repositories

### Step 3: Create New Blueprint

1. On Render Dashboard, click **"New +"** (top right)
2. Select **"Blueprint"**
3. Click **"Connect Repository"**
4. Find and select: `Carnet-de-sant--Django`
5. Select branch: `feature/ai-recommendations-improvements`
6. Render will auto-detect `render.yaml`
7. Click **"Apply"** to create services

### Step 4: Configure Services

Render will create TWO services:

#### A. PostgreSQL Database (`carnet-sante-db`)
- **Plan**: Free (up to 1GB storage)
- **Database Name**: `carnet_sante`
- **User**: `carnet_sante_user`
- **Status**: Auto-creates, no configuration needed

#### B. Web Service (`carnet-sante-django`)
- **Plan**: Free
- **Runtime**: Python 3.11.0
- **Build Command**: `./build.sh`
- **Start Command**: `gunicorn projetPython.wsgi:application`
- **Environment**: Auto-linked to database

### Step 5: Set Environment Variables (Optional)

While most variables are auto-configured, you can customize:

Go to **Web Service Settings â†’ Environment** and add:

```bash
# Auto-superuser creation (optional - recommended for first deploy)
DJANGO_SUPERUSER_USERNAME=admin
DJANGO_SUPERUSER_EMAIL=admin@example.com
DJANGO_SUPERUSER_PASSWORD=YourSecurePassword123!

# Custom domain (if you have one)
ALLOWED_HOSTS=.onrender.com,yourdomain.com
```

**Note**: `SECRET_KEY`, `DATABASE_URL`, `DEBUG`, and base `ALLOWED_HOSTS` are already set by `render.yaml`.

### Step 6: Deploy!

1. Click **"Manual Deploy"** or wait for auto-deploy
2. Watch the **"Logs"** tab for build progress
3. Build takes ~5-10 minutes:
   - Installing Python dependencies
   - Installing ML packages (NumPy, Scikit-learn)
   - Collecting static files
   - Running migrations
   - Creating superuser (if env vars set)

### Step 7: Get Your Live URL

Once deployment succeeds:
- **Live URL**: `https://carnet-sante-django.onrender.com`
- Or custom name: `https://[your-app-name].onrender.com`

---

## ğŸ” Environment Variables

### Auto-Configured (by `render.yaml`)

| Variable | Value | Source |
|----------|-------|--------|
| `DATABASE_URL` | `postgresql://...` | Auto-linked from database |
| `SECRET_KEY` | `<random-string>` | Auto-generated by Render |
| `DEBUG` | `False` | Set in render.yaml |
| `ALLOWED_HOSTS` | `.onrender.com` | Set in render.yaml |
| `PYTHON_VERSION` | `3.11.0` | Set in render.yaml |
| `WEB_CONCURRENCY` | `4` | Gunicorn workers |

### Optional (Set Manually)

| Variable | Example | Purpose |
|----------|---------|---------|
| `DJANGO_SUPERUSER_USERNAME` | `admin` | Auto-create admin user |
| `DJANGO_SUPERUSER_EMAIL` | `admin@example.com` | Admin email |
| `DJANGO_SUPERUSER_PASSWORD` | `SecurePass123!` | Admin password |

---

## âœ… Post-Deployment Testing

### 1. Check Homepage
```bash
curl https://carnet-sante-django.onrender.com/
```
**Expected**: HTML response (no 500 errors)

### 2. Access Admin Panel
URL: `https://carnet-sante-django.onrender.com/admin/`

**Login with**:
- Username: `admin` (or your `DJANGO_SUPERUSER_USERNAME`)
- Password: Your `DJANGO_SUPERUSER_PASSWORD`

**Expected**: Django admin dashboard loads

### 3. Test AI Recommendations Dashboard
URL: `https://carnet-sante-django.onrender.com/reco/dashboard/`

**Expected**:
- Dashboard loads
- Can add health metrics
- Can generate recommendations

### 4. Test Recommendations Page
URL: `https://carnet-sante-django.onrender.com/reco/recommendations/`

**Expected**:
- Shows personalized recommendations
- Displays confidence scores (68-93%)
- Feedback buttons work
- Can mark helpful/acted upon

### 5. Test AI Progress Page
URL: `https://carnet-sante-django.onrender.com/reco/ai-progress/`

**Expected**:
- Shows learning statistics
- Feedback count updates
- Confidence trends display
- Milestones track progress

### 6. Test ML Model Loading
Check Render logs for:
```
[INFO] Loading ML model from: models/v1/model_calibrated.joblib
[INFO] âœ… Calibrated model loaded successfully!
[INFO] Model accuracy: 93.75%
```

**Expected**: ML model loads without errors

---

## ğŸ› Troubleshooting

### Issue: Build Fails with "Module not found"

**Cause**: Missing dependency in requirements files

**Fix**:
```bash
# Check which module is missing from logs
# Add to requirements.txt or requirements_ai.txt
git add requirements.txt
git commit -m "Add missing dependency"
git push
```

### Issue: Database Connection Errors

**Symptoms**:
```
django.db.utils.OperationalError: FATAL: password authentication failed
```

**Fix**:
1. Go to Render dashboard
2. Check **Web Service â†’ Environment**
3. Verify `DATABASE_URL` is set and starts with `postgresql://`
4. Restart web service

### Issue: Static Files Not Loading (CSS/JS missing)

**Symptoms**: Page loads but no styling

**Fix**:
1. Check logs for `collectstatic` output:
   ```
   121 static files copied to '/opt/render/project/src/staticfiles'
   ```
2. Verify `build.sh` ran successfully
3. Check `STATIC_ROOT` in settings.py
4. Restart web service

### Issue: 500 Server Error on Homepage

**Fix**:
1. Check Render logs for error traceback
2. Common causes:
   - Missing migrations: Re-run `python manage.py migrate`
   - ML model not found: Check `models/v1/` directory exists
   - Secret key not set: Render should auto-generate
3. Check settings:
   ```bash
   # In Render shell (Dashboard â†’ Shell button)
   python manage.py check --deploy
   ```

### Issue: ML Model Not Loading

**Symptoms**: Recommendations show 68% confidence (base ML) always

**Logs**:
```
[ERROR] Failed to load ML model: [Errno 2] No such file or directory: 'models/v1/model_calibrated.joblib'
```

**Fix**:
1. Verify `models/v1/` directory is in your repository
2. Check files exist:
   ```bash
   ls -la models/v1/
   # Should show: model_calibrated.joblib, scaler.joblib
   ```
3. Ensure `models/` directory is not in `.gitignore`
4. Re-commit and push:
   ```bash
   git add models/
   git commit -m "Add ML model files"
   git push
   ```

### Issue: Superuser Not Created

**Fix - Manual Creation**:
1. Go to Render Dashboard â†’ Web Service
2. Click **"Shell"** button (opens terminal)
3. Run:
   ```bash
   python manage.py createsuperuser
   # Follow prompts
   ```

### Issue: Feedback Not Saving

**Symptoms**: Clicking feedback buttons doesn't update stats

**Fix**:
1. Check PostgreSQL connection (should be automatic)
2. Check migrations applied:
   ```bash
   python manage.py showmigrations reco
   # All should have [X] checkmarks
   ```
3. Check Render logs for save errors
4. Test API directly:
   ```bash
   curl -X POST https://[your-app].onrender.com/api/recommendations/[id]/provide_feedback/ \
     -H "Content-Type: application/json" \
     -d '{"helpful": true, "acted_upon": false}'
   ```

### Issue: App Goes to Sleep (Free Tier)

**Symptoms**: First load after 15+ minutes is slow

**Cause**: Render free tier sleeps after inactivity

**Solutions**:
1. **Upgrade to paid plan** ($7/month) for 24/7 uptime
2. **Use external ping service**:
   - [UptimeRobot](https://uptimerobot.com) (free)
   - Ping your URL every 5 minutes
3. **Accept the limitation** (expected on free tier)

---

## ğŸ› ï¸ Useful Commands

### View Logs (Real-time)
Go to Render Dashboard â†’ Web Service â†’ **"Logs"** tab

### Open Shell (for Django commands)
Go to Render Dashboard â†’ Web Service â†’ **"Shell"** button

### Run Django Management Commands
```bash
# In Render Shell

# Check deployment config
python manage.py check --deploy

# Show migrations
python manage.py showmigrations

# Create superuser manually
python manage.py createsuperuser

# Generate recommendations for a user
python manage.py genrecos --username [username]

# Export training data
python manage.py export_training_data --output ./training_data
```

### Restart Service
Go to Render Dashboard â†’ Web Service â†’ **"Manual Deploy" â†’ "Clear build cache & deploy"**

### View Database Info
Go to Render Dashboard â†’ Database Service â†’ **"Info"** tab
- Connection string
- Database name
- Username
- Password

### Connect to PostgreSQL Directly
```bash
# Get DATABASE_URL from Render dashboard
psql [DATABASE_URL]
```

### Force Rebuild
```bash
# Locally, make a small change
git commit --allow-empty -m "Force rebuild"
git push origin feature/ai-recommendations-improvements
```

---

## ğŸ“Š Expected Build Output

Successful build logs should show:

```
==> Building with environment:
    PYTHON_VERSION=3.11.0

==> Cloning from https://github.com/azizsalmii/Carnet-de-sant--Django...
    Branch: feature/ai-recommendations-improvements

==> Running build command: './build.sh'...
    Installing dependencies from requirements.txt...
    Installing dependencies from requirements_ai.txt...
    
    Collecting static files...
    121 static files copied to '/opt/render/project/src/staticfiles'.
    
    Running migrations...
    Operations to perform:
      Apply all migrations: admin, auth, contenttypes, sessions, users, journal, ai_models, detection, reco
    Running migrations:
      Applying contenttypes.0001_initial... OK
      Applying auth.0001_initial... OK
      ...
      Applying reco.0005_recommendation_score... OK
    
    Superuser created successfully!

==> Build succeeded ğŸ‰

==> Starting service with 'gunicorn projetPython.wsgi:application'...
    [INFO] Starting gunicorn 21.2.0
    [INFO] Listening at: http://0.0.0.0:10000 (1)
    [INFO] Using worker: sync
    [INFO] Booting worker with pid: 23

==> Your service is live at https://carnet-sante-django.onrender.com ğŸš€
```

---

## ğŸ¯ Success Checklist

After deployment, verify:

- [ ] App loads at Render URL (no 500 errors)
- [ ] Admin panel accessible (`/admin/`)
- [ ] Can log in with superuser credentials
- [ ] Dashboard loads (`/reco/dashboard/`)
- [ ] Can add health metrics
- [ ] Can generate recommendations
- [ ] Recommendations page shows AI suggestions (`/reco/recommendations/`)
- [ ] Confidence scores display (68-93%)
- [ ] Feedback buttons work (helpful/acted upon)
- [ ] AI Progress page shows stats (`/reco/ai-progress/`)
- [ ] Feedback count updates after giving feedback
- [ ] Confidence accumulates with more feedback
- [ ] Static files load (CSS/JS work)
- [ ] Images display correctly
- [ ] No errors in Render logs

---

## ğŸ“š Additional Resources

- **Render Docs**: [render.com/docs/deploys](https://render.com/docs/deploys)
- **Django Deployment Checklist**: [docs.djangoproject.com/en/stable/howto/deployment/checklist/](https://docs.djangoproject.com/en/stable/howto/deployment/checklist/)
- **PostgreSQL on Render**: [render.com/docs/databases](https://render.com/docs/databases)
- **GitHub Repository**: [github.com/azizsalmii/Carnet-de-sant--Django](https://github.com/azizsalmii/Carnet-de-sant--Django)

---

## ğŸ‰ Congratulations!

Your AI-powered health tracking app is now live on Render with:
- âœ… PostgreSQL database
- âœ… ML recommendation system
- âœ… Cumulative confidence learning
- âœ… Feedback persistence
- âœ… Production-ready security

**Share your live URL**: `https://carnet-sante-django.onrender.com` ğŸš€

---

## ğŸ“ Support

If you encounter issues not covered in this guide:
1. Check Render logs for detailed error messages
2. Review GitHub repository issues
3. Consult Django and Render documentation
4. Verify all deployment files are committed and pushed

**Happy deploying!** ğŸŠ
