{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Dashboard - AI Health Recommendations | Medic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- Vendor CSS -->
  <link rel="stylesheet" href="{% static 'plugins/slick/slick.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/slick/slick-theme.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/fancybox/jquery.fancybox.min.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- Theme -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  {# ===== Header dropdown minimal CSS (identique à la page Recommendations) ===== #}
  <style>
    .hx-nav { display:flex; align-items:center; gap:28px; height:64px; }
    .hx-menu { display:flex; align-items:center; gap:28px; margin:0; padding:0; list-style:none; flex:1; }
    .hx-menu > li > a { color:#fff; text-transform:uppercase; font-weight:700; text-decoration:none; }
    .hx-dd { position:relative; }
    .hx-dd-toggle { display:flex; align-items:center; gap:8px; color:#fff; text-transform:uppercase; font-weight:700; text-decoration:none; }
    .hx-caret { font-size:10px; opacity:.85; margin-left:6px; }
    .hx-dd-menu {
      position:absolute; top:100%; left:0; min-width:220px; background:#ffffff;
      border-radius:10px; padding:10px; margin-top:10px; box-shadow:0 10px 30px rgba(0,0,0,.12);
      border:1px solid rgba(0,0,0,.06); display:none; z-index:50;
    }
    .hx-dd:hover .hx-dd-menu, .hx-dd:focus-within .hx-dd-menu { display:block; }
    .hx-dd-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:8px; color:#223; text-decoration:none; white-space:nowrap; }
    .hx-dd-item i { width:18px; text-align:center; color:#39b7bd; }
    .hx-dd-item:hover { background:#f2fbfb; }
    @media (max-width: 768px) {
      .hx-nav { flex-wrap:wrap; height:auto; padding:10px 0; }
      .hx-menu { flex-wrap:wrap; gap:16px; }
      .hx-dd-menu { position:static; box-shadow:none; border:none; padding:6px 0; margin:4px 0 0; display:none; background:#39b7bd10; }
      .hx-dd:hover .hx-dd-menu { display:block; }
      .hx-dd-item { color:#fff; }
    }
  </style>

  {# ===== Styles d’amélioration pour le Dashboard ===== #}
  <style>
    :root{
      --hx-primary:#39b7bd;
      --hx-primary-600:#2aa6ac;
      --hx-indigo:#667eea;
      --hx-purple:#764ba2;
      --hx-emerald:#50C878;
      --hx-orange:#F39C12;
      --hx-red:#E74C3C;
      --hx-blue:#4A90E2;
      --hx-card:#ffffff;
      --hx-muted:#6b7a90;
      --hx-dark:#22304a;
      --hx-shadow:0 10px 30px rgba(0,0,0,.08);
      --hx-r:14px;
    }

    .page-section{ padding-top:28px; padding-bottom:28px; }

    /* Metric cards */
    .metric-card{
      background:var(--hx-card); border-radius:14px; box-shadow:var(--hx-shadow);
      padding:16px; display:flex; align-items:center; gap:14px; border:1px solid #eef2f5; height:100%;
    }
    .metric-icon{
      width:46px; height:46px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:20px;
    }
    .metric-content h3{ margin:0; font-weight:800; }
    .metric-content p{ margin:0; color:var(--hx-muted); font-size:12px; text-transform:uppercase; letter-spacing:.03em; }

    /* Cards */
    .card{ border-radius:14px; border:1px solid #eef2f5; }
    .card-header{ border-top-left-radius:14px !important; border-top-right-radius:14px !important; }
    .shadow-gradient{
      background: linear-gradient(135deg, var(--hx-indigo) 0%, var(--hx-purple) 100%);
      color:#fff; border-radius:15px; box-shadow:var(--hx-shadow); border:0;
    }

    /* Recommendation mini bloc */
    .recommendation-mini{ background:#f8f9fa; border-radius:12px; border:1px solid #e9edf2; }

    /* Table */
    .table thead th{ border-bottom:2px solid #e4ebf2; font-weight:800; color:#33415c; }
    .table-hover tbody tr:hover{ background:#fafcfd; }

    /* Buttons */
    .btn-lg{ border-radius:10px; font-weight:800; }
    .btn-primary{ background:var(--hx-primary); border-color:var(--hx-primary); }
    .btn-primary:hover{ background:var(--hx-primary-600); border-color:var(--hx-primary-600); }
    .btn-outline-success, .btn-outline-warning, .btn-outline-info{ border-width:2px; }

    /* Chart canvas spacing on mobile */
    @media (max-width: 576px){
      canvas{ max-height:260px; }
    }
  </style>
</head>

<body>
<div class="page-wrapper">

  {# ================== HEADER (identique Recommendations) ================== #}
  <div style="background:#ffffff;border-bottom:1px solid #eee;">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;height:48px;">
      <div style="color:#333;font-size:14px;">Opening Hours: Saturday to Tuesday — 8am to 10pm</div>

      <div style="display:flex;align-items:center;gap:18px;">
        <div style="display:flex;gap:14px;color:#666;">
          <a href="#" style="color:#666;"><i class="fab fa-facebook-f"></i></a>
          <a href="#" style="color:#666;"><i class="fab fa-twitter"></i></a>
          <a href="#" style="color:#666;"><i class="fab fa-google-plus-g"></i></a>
          <a href="#" style="color:#666;"><i class="fab fa-instagram"></i></a>
          <a href="#" style="color:#666;"><i class="fab fa-pinterest-p"></i></a>
        </div>

        <div style="display:flex;gap:10px;">
          {% if request.user.is_authenticated %}
            <a href="{% url 'profile' %}" class="btn btn-sm" style="background:#eef7ff;border:1px solid #cfe3ff;color:#0b5ed7;padding:6px 10px;border-radius:6px;">
              <i class="fa fa-user-circle"></i> Profile
            </a>
            <a href="{% url 'logout' %}" class="btn btn-sm" style="background:#0b5ed7;border:1px solid #0b5ed7;color:#fff;padding:6px 10px;border-radius:6px;">
              <i class="fa fa-sign-out-alt"></i> Log Out
            </a>
          {% else %}
            <a href="{% url 'login' %}" class="btn btn-sm" style="background:#eef7ff;border:1px solid #cfe3ff;color:#0b5ed7;padding:6px 10px;border-radius:6px;">
              <i class="fa fa-right-to-bracket"></i> Log In
            </a>
            <a href="{% url 'signup' %}" class="btn btn-sm" style="background:#0b5ed7;border:1px solid #0b5ed7;color:#fff;padding:6px 10px;border-radius:6px;">
              <i class="fa fa-user-plus"></i> Sign Up
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <nav style="background:#39b7bd;">
    <div class="container hx-nav">
      <a href="{% url 'home' %}" style="display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none;">
        <img src="{% static 'images/logo.png' %}" alt="Medic.AI" style="height:36px;">
        <strong style="font-size:22px;line-height:1;">Health Track</strong>
      </a>

      <ul class="hx-menu">
        <li><a href="{% url 'home' %}">Home</a></li>

        <li class="hx-dd">
          <a href="#" class="hx-dd-toggle" aria-haspopup="true" aria-expanded="false">
            <i class="fa fa-microscope"></i> Diagnostics <span class="hx-caret"><i class="fa fa-caret-down"></i></span>
          </a>
          <div class="hx-dd-menu" role="menu" aria-label="Diagnostics">
            <a class="hx-dd-item" href="{% url 'brain_tumor_page' %}"><i class="fa fa-brain"></i> Brain Tumor AI</a>
            <a class="hx-dd-item" href="{% url 'chest_xray_page' %}"><i class="fa fa-stethoscope"></i> Chest X-Ray AI</a>
          </div>
        </li>

        <li class="hx-dd">
          <a href="#" class="hx-dd-toggle" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-notes-medical"></i> Medical Infos <span class="hx-caret"><i class="fa fa-caret-down"></i></span>
          </a>
          <div class="hx-dd-menu" role="menu" aria-label="Medical Infos">
            <a class="hx-dd-item" href="{% url 'health_data_list' %}"><i class="fas fa-chart-line"></i> My Data</a>
            <a class="hx-dd-item" href="{% url 'report_list' %}"><i class="fas fa-file-medical"></i> My Reports</a>
            <a class="hx-dd-item" href="{% url 'journal_page' %}"><i class="fas fa-book"></i> Journal</a>
          </div>
        </li>

        <li>
          <a href="{% url 'reco:recommendations' %}" style="display:flex;align-items:center;gap:8px;">
            <i class="fa fa-lightbulb"></i> Recommendations
          </a>
        </li>

        <li>
          <a href="{% url 'health_analysis' %}" style="display:flex;align-items:center;gap:8px;">
            <i class="fa fa-heartbeat"></i> Health Analysis
          </a>
        </li>
      </ul>
    </div>
  </nav>
  {# ================== /HEADER ================== #}

  {# ================== CONTENU ================== #}
  <div class="container page-section">

    <!-- Welcome Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-gradient">
          <div class="card-body p-4">
            
          </div>
        </div>
      </div>
    </div>

    {% if metrics_count == 0 %}
    <!-- Onboarding -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="alert alert-info shadow-sm" style="border-left: 5px solid var(--hx-indigo); border-radius:12px;">
          <h4 class="alert-heading"><i class="fas fa-info-circle"></i> Bienvenue chez HEALTH TRACK !</h4>
          <p class="mb-3">Votre dashboard est vide car vous n'avez pas encore ajouté de métriques de santé.</p>
          <hr>
          <p class="mb-3"><strong>Pour commencer :</strong></p>
          <ol class="mb-3">
            <li>Cliquez sur <strong>"Ajouter mes métriques du jour"</strong></li>
            <li>Remplissez vos données : pas, sommeil, tension artérielle</li>
            <li>Ajoutez au moins <strong>2-3 jours de données</strong> pour obtenir des statistiques</li>
            <li>Visitez la page <strong>"Recommandations"</strong> pour des conseils personnalisés</li>
          </ol>
          <div class="text-center mt-4">
            <a href="{% url 'reco:add_metrics' %}" class="btn btn-primary btn-lg">
              <i class="fas fa-plus-circle"></i> Ajouter mes métriques du jour
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="metric-card">
          <div class="metric-icon" style="background-color: var(--hx-indigo);">
            <i class="fas fa-moon"></i>
          </div>
          <div class="metric-content">
            <h3>{{ avg_sleep|floatformat:1|default:"--" }}h</h3>
            <p>Sommeil Moyen (7j)</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="metric-card">
          <div class="metric-icon" style="background-color: var(--hx-emerald);">
            <i class="fas fa-walking"></i>
          </div>
          <div class="metric-content">
            <h3>{{ avg_steps|floatformat:0|default:"--" }}</h3>
            <p>Pas Moyens (7j)</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="metric-card">
          <div class="metric-icon" style="background-color: var(--hx-orange);">
            <i class="fas fa-heartbeat"></i>
          </div>
          <div class="metric-content">
            <h3>{{ latest_bp|default:"--/--" }}</h3>
            <p>Tension Artérielle</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="metric-card">
          <div class="metric-icon" style="background-color: var(--hx-red);">
            <i class="fas fa-lightbulb"></i>
          </div>
          <div class="metric-content">
            <h3>{{ recommendations_count }}</h3>
            <p>Recommandations</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="row">
      <!-- Charts -->
      <div class="col-lg-8 mb-4">
        <div class="card shadow-sm mb-4">
          <div class="card-header" style="background-color:#f8f9fa;border-bottom:2px solid var(--hx-indigo);">
            <h5 class="mb-0"><i class="fas fa-moon"></i> Évolution du Sommeil (7 derniers jours)</h5>
          </div>
          <div class="card-body">
            <canvas id="sleepChart" height="80"></canvas>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-header" style="background-color:#f8f9fa;border-bottom:2px solid var(--hx-emerald);">
            <h5 class="mb-0"><i class="fas fa-walking"></i> Évolution des Pas (7 derniers jours)</h5>
          </div>
          <div class="card-body">
            <canvas id="stepsChart" height="80"></canvas>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header" style="background-color:#f8f9fa;border-bottom:2px solid var(--hx-blue);">
            <h5 class="mb-0"><i class="fas fa-table"></i> Métriques Récentes</h5>
          </div>
          <div class="card-body">
            {% if metrics %}
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th><i class="fas fa-calendar"></i> Date</th>
                      <th><i class="fas fa-moon"></i> Sommeil (h)</th>
                      <th><i class="fas fa-walking"></i> Pas</th>
                      <th><i class="fas fa-heartbeat"></i> Tension</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for metric in metrics %}
                    <tr>
                      <td>{{ metric.date|date:"d/m/Y" }}</td>
                      <td>
                        <span class="badge {% if metric.sleep_hours < 6 %}bg-danger{% elif metric.sleep_hours < 7 %}bg-warning{% else %}bg-success{% endif %}">
                          {{ metric.sleep_hours }} h
                        </span>
                      </td>
                      <td>
                        <span class="badge {% if metric.steps < 5000 %}bg-danger{% elif metric.steps < 8000 %}bg-warning{% else %}bg-success{% endif %}">
                          {{ metric.steps }}
                        </span>
                      </td>
                      <td>
                        {% if metric.systolic_bp and metric.diastolic_bp %}
                          <span class="badge {% if metric.systolic_bp > 140 %}bg-danger{% elif metric.systolic_bp > 130 %}bg-warning{% else %}bg-success{% endif %}">
                            {{ metric.systolic_bp }}/{{ metric.diastolic_bp }}
                          </span>
                        {% else %}
                          <span class="text-muted">--</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune métrique enregistrée pour le moment.</p>
                <a href="{% url 'reco:add_metrics' %}" class="btn btn-primary">
                  <i class="fas fa-plus"></i> Ajouter des métriques
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="col-lg-4 mb-4">
        <!-- Recent Recommendations -->
        <div class="card shadow-sm mb-4">
          <div class="card-header" style="background-color:#f8f9fa;border-bottom:2px solid var(--hx-purple);">
            <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Recommandations Récentes</h5>
          </div>
          <div class="card-body">
            {% if recent_recommendations %}
              {% for reco in recent_recommendations %}
              <div class="recommendation-mini mb-3 p-3"
                   style="border-left:4px solid {% if reco.category == 'sleep' %}var(--hx-indigo){% elif reco.category == 'activity' %}var(--hx-emerald){% elif reco.category == 'nutrition' %}var(--hx-orange){% else %}var(--hx-blue){% endif %};">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge"
                        style="background-color:{% if reco.category == 'sleep' %}var(--hx-indigo){% elif reco.category == 'activity' %}var(--hx-emerald){% elif reco.category == 'nutrition' %}var(--hx-orange){% else %}var(--hx-blue){% endif %};">
                    {% if reco.category == 'sleep' %}🌙 Sommeil{% elif reco.category == 'activity' %}🏃 Activité{% elif reco.category == 'nutrition' %}🥗 Nutrition{% else %}💡 Lifestyle{% endif %}
                  </span>
                  <small class="text-muted">{{ reco.created_at|date:"d/m" }}</small>
                </div>
                <p class="mb-0 small">{{ reco.text|truncatewords:15 }}</p>
              </div>
              {% endfor %}
              <a href="{% url 'reco:recommendations' %}" class="btn btn-outline-primary btn-sm w-100">
                <i class="fas fa-arrow-right"></i> Voir toutes les recommandations
              </a>
            {% else %}
              <div class="text-center py-4">
                <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-3">Pas encore de recommandations.</p>
                <a href="{% url 'reco:recommendations' %}" class="btn btn-primary btn-sm">
                  <i class="fas fa-magic"></i> Générer des recommandations
                </a>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow-sm mb-4">
          <div class="card-header" style="background-color:#f8f9fa;border-bottom:2px solid var(--hx-emerald);">
            <h5 class="mb-0"><i class="fas fa-bolt"></i> Actions Rapides</h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <a href="{% url 'reco:add_metrics' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus-circle me-2"></i>Ajouter mes métriques du jour
              </a>
              <a href="{% url 'reco:recommendations' %}" class="btn btn-outline-success">
                <i class="fas fa-magic me-2"></i>Voir mes recommandations
              </a>
              <a href="{% url 'reco:ai_progress' %}" class="btn btn-outline-warning">
                <i class="fas fa-brain me-2"></i>Progression de l'IA
              </a>
              <a href="{% url 'reco:profile' %}" class="btn btn-outline-info">
                <i class="fas fa-user-edit me-2"></i>Modifier mon profil
              </a>
            </div>
          </div>
        </div>

        <!-- ML Model Info -->
        <div class="card shadow-gradient">
          <div class="card-body text-center">
            <i class="fas fa-brain fa-3x mb-3"></i>
            <h5 class="mb-2">Intelligence Artificielle</h5>
            <p class="mb-2">Modèle RandomForest v1</p>
            <h3 class="mb-0">93.75% de précision</h3>
            <small>16 indicateurs analysés</small>
          </div>
        </div>
      </div>
    </div>

  </div>
  {# ================== /CONTENU ================== #}

  {# ================== FOOTER (identique Recommendations) ================== #}
  <footer class="footer-main">
    <div class="footer-top">
      <div class="container">
        <div class="row">
          <!-- … ton footer (colonnes, posts, etc.) … -->
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container clearfix">
        <div class="copyright-text">
          <p>&copy; Copyright 2018. All Rights Reserved by
            <a href="{% url 'home' %}">Medic</a>
          </p>
        </div>
        <ul class="footer-bottom-link">
          <li><a href="{% url 'home' %}">Home</a></li>
          <li><a href="{% url 'about' %}">About</a></li>
          <li><a href="{% url 'contact' %}">Contact</a></li>
        </ul>
      </div>
    </div>
  </footer>

  <div class="scroll-to-top scroll-to-target" data-target=".header-top">
    <span class="fas fa-angle-up"></span>
  </div>
</div>

<!-- Vendor JS -->
<script src="{% static 'plugins/jquery.js' %}"></script>
<script src="{% static 'plugins/bootstrap.min.js' %}"></script>
<script src="{% static 'plugins/bootstrap-select.min.js' %}"></script>
<script src="{% static 'plugins/slick/slick.min.js' %}"></script>
<script src="{% static 'plugins/fancybox/jquery.fancybox.min.js' %}"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>
<script src="{% static 'plugins/google-map/gmap.js' %}"></script>
<script src="{% static 'plugins/validate.js' %}"></script>
<script src="{% static 'plugins/wow.js' %}"></script>
<script src="{% static 'plugins/jquery-ui.js' %}"></script>
<script src="{% static 'plugins/timePicker.js' %}"></script>
<script src="{% static 'js/script.js' %}"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
/* Sleep Chart */
const sleepCtx = document.getElementById('sleepChart');
if (sleepCtx) {
  new Chart(sleepCtx, {
    type: 'line',
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        label: 'Heures de sommeil',
        data: {{ sleep_data|safe }},
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.12)',
        tension: 0.35,
        fill: true,
        pointRadius: 3,
        pointHoverRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false }},
      scales: {
        y: {
          beginAtZero: true,
          max: 12,
          ticks: { callback: (v)=> v + 'h' },
          grid: { color: 'rgba(0,0,0,0.06)' }
        },
        x: { grid: { display:false } }
      }
    }
  });
}

/* Steps Chart */
const stepsCtx = document.getElementById('stepsChart');
if (stepsCtx) {
  new Chart(stepsCtx, {
    type: 'bar',
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        label: 'Nombre de pas',
        data: {{ steps_data|safe }},
        backgroundColor: '#50C878',
        borderRadius: 8,
        maxBarThickness: 36
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false }},
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: (v)=> v.toLocaleString() },
          grid: { color: 'rgba(0,0,0,0.06)' }
        },
        x: { grid: { display:false } }
      }
    }
  });
}
</script>
</body>
</html>
